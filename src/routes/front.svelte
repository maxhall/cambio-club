<script>
  /** @typedef {import('../types').Card} Card */
  // Original "Cambio club" viewbox: viewBox="0 0 1182 142"
  // Original "Cambio club" clipPath transform: scale(0.000846023688663 0.00704225352113)

  import { onMount } from "svelte";
  import CardPath from "../components/CardPath.svelte";
  import FallingCard from "../components/FallingCard.svelte";
  import { shuffledDeck } from "../utils";

  // TODO: Tie the size of the cards and the spawn rate to the screen size
  // This is from to the 500 700 viewbox of the cards used in game
  const cardHeightMultiple = 1.4;
  const initialCards = 8;
  const widthMin = 50;
  const widthMax = 180;
  const timeMin = 7000;
  const timeMax = 20000;
  const spawnInterval = 250;
  let deck = shuffledDeck();

  /** @type {number} */
  let innerWidth;
  /** @type {number} */
  let innerHeight;
  /** @type {number} */
  let outerWidth;
  /** @type {number} */
  let outerHeight;
  let id = 0;
  /** @typedef {import('../types').Rank} Rank */
  /** @typedef {import('../types').Suit} Suit */
  /** @typedef {{x: number, y: number, r: number}} Transform */
  /** @typedef {{id: number, rank: Rank, suit: Suit, width: number, duration: number, initial: Transform, final: Transform}} FallingCard */
  /** @type {FallingCard[]}*/
  let cards = [];

  onMount(() => {
    cards = new Array(initialCards).fill(null).map((_) => {
      return randomCard();
    });

    const spawn = setInterval(() => {
      cards = [...cards, randomCard()];
    }, spawnInterval);
    return () => clearInterval(spawn);
  });

  function randomCard() {
    const newId = id++;
    const duration = randomBetween(timeMin, timeMax);
    // Destroy the component once it's duration has elapsed
    const timer = setTimeout(() => {
      // This feels expensive, but will do for now
      cards = cards.filter((c) => c.id !== newId);
    }, duration);
    const width = randomBetween(widthMin, widthMax);
    const height = width * cardHeightMultiple;
    const hypotenuse = Math.sqrt(
      width * width + height * cardHeightMultiple * height * cardHeightMultiple
    );
    const finalX = randomBetween(0, outerWidth);
    // TODO: offset to account for the transform origin of the card?
    if (deck.length < 1) deck = shuffledDeck();
    const { suit, rank } = /** @type {Card} */ (deck.pop());

    return {
      suit,
      rank,
      id: newId,
      width,
      duration,
      initial: {
        x: finalX,
        y: -hypotenuse,
        r: randomBetween(0, 1),
      },
      final: {
        x: finalX,
        y: outerHeight + hypotenuse,
        r: randomBetween(0, 1),
      },
    };
  }

  /**
   * @param min {number}
   * @param max {number}
   */
  function randomBetween(min, max) {
    return Math.random() * (max - min) + min;
  }
</script>

<svelte:window
  bind:innerWidth
  bind:innerHeight
  bind:outerWidth
  bind:outerHeight
/>
<svg
  width={innerWidth}
  height={innerHeight}
  viewBox="0 0 {innerWidth} {innerHeight}"
  xmlns="http://www.w3.org/2000/svg"
>
  <defs>
    <clipPath id="clip">
      <path
        d="M237.992,133.051l-48.872,-133.029l-34.585,0l-49.247,133.029l35.337,-0l6.579,-21.292l48.871,-0l6.579,21.292l35.338,-0Zm-49.435,-45.222l-33.646,-0l16.353,-56.151l17.293,56.151Zm199.995,45.222l0,-133.029l-48.495,0l-24.623,93.083l-25,-93.083l-48.495,0l-0,133.029l32.33,-0c0,-0 -0.188,-80.835 -0.752,-99.489l27.443,99.489l28.759,-0l27.631,-99.489c-0.752,26.003 -0.752,99.489 -0.752,99.489l31.954,-0Zm7.331,-0l65.036,-0c27.067,-0 48.871,-12.813 48.871,-37.308c0,-23.365 -20.676,-29.96 -33.457,-31.091c8.082,-0.942 28.382,-7.348 28.382,-29.771c0,-19.408 -12.029,-34.859 -46.991,-34.859l-61.841,0l0,133.029Zm31.578,-80.458l0,-27.699l27.255,0c6.391,0 17.481,0.566 17.481,13.379c0,13.755 -12.593,14.32 -19.736,14.32l-25,-0Zm0,56.339l0,-32.221l28.571,0c6.767,0 20.113,0.377 20.113,16.394c-0,15.262 -14.85,15.827 -25.564,15.827l-23.12,0Zm119.735,24.119l-0,-133.029l-33.082,0l-0,133.029l33.082,-0Zm407.322,-0l0,-28.076l-51.879,0l0,-104.953l-33.082,0l0,133.029l84.961,-0Zm114.095,-133.029l-33.27,0l0,84.792c0,15.262 -5.827,23.742 -22.743,23.742c-14.85,-0 -23.872,-4.334 -23.872,-22.046l-0,-86.488l-33.458,0l-0,82.719c-0,36.743 24.999,53.325 56.202,53.325c35.901,-0 57.141,-22.235 57.141,-55.586l0,-80.458Zm-238.575,-0.022l-45,-0c-25.2,9.694 -41.606,35.473 -41.606,66.348c0,45.034 28.383,70.66 63.533,70.66c27.631,-0 46.615,-15.828 57.141,-34.294l-26.127,-13.378c-4.511,7.726 -11.466,19.785 -28.759,19.785c-17.856,-0 -32.706,-14.509 -32.706,-43.715c0,-22.234 11.278,-42.208 32.706,-42.208c13.534,0 25.376,10.364 28.195,20.35l26.315,-13.189c-6.405,-13.612 -18.746,-24.686 -33.692,-30.359Zm-188.074,0.022l-49.457,0c-29.521,10.956 -40.988,41.51 -40.988,65.949c-0,36.555 22.18,71.037 65.976,71.037c42.668,-0 66.916,-33.917 66.916,-69.529c-0,-25.524 -12.342,-56.438 -42.447,-67.457Zm-57.739,65.572c-0,-17.9 7.707,-41.83 32.894,-41.83c23.496,-0 34.022,19.219 34.022,43.338c-0,18.654 -8.835,41.642 -33.458,41.642c-23.872,-0 -33.458,-21.857 -33.458,-43.15Zm596.877,52.13l0,-42.407c-7.187,-7.27 -17.877,-9.977 -25.648,-10.665c6.256,-0.729 19.831,-4.732 25.648,-16.903l0,-27.242c-5.248,-12.136 -18.557,-20.485 -44.257,-20.485l-61.841,0l0,133.029l65.036,-0c17.256,-0 32.372,-5.207 41.062,-15.327Zm-74.519,-8.792l-0,-32.221l28.57,0c6.767,0 20.113,0.377 20.113,16.394c-0,15.262 -14.85,15.827 -25.564,15.827l-23.119,0Zm-0,-56.339l-0,-27.699l27.255,0c6.39,0 17.48,0.566 17.48,13.379c0,13.755 -12.593,14.32 -19.736,14.32l-24.999,-0Zm-1106.58,-20.752l-0,70.901c10.751,22.171 31.705,34.266 55.853,34.266c27.631,-0 46.615,-15.828 57.141,-34.294l-26.127,-13.378c-4.511,7.726 -11.466,19.785 -28.759,19.785c-17.857,-0 -32.706,-14.509 -32.706,-43.715c0,-22.234 11.278,-42.208 32.706,-42.208c13.534,0 25.376,10.364 28.195,20.35l26.315,-13.189c-6.396,-13.594 -18.713,-24.657 -33.634,-30.337l-45.115,0c-14.889,5.746 -26.703,17.109 -33.869,31.819Z"
      />
    </clipPath>
  </defs>
  <!-- The translate here could be finessed	 -->
  <g transform="scale({innerWidth / 1182} {innerWidth / 1182}) translate(1 1)">
    <!-- <g transform="scale(1 1) translate(50 100)">
		<rect width="100" height="140" rx="10" fill="white"></rect>
		<g transform="scale(0.2)">
		<CardPath rank={"jack"} suit={"hearts"} />
		</g>
	</g> -->
    <!-- <g>
		<CardPath rank={"jack"} suit={"clubs"} />
	</g> -->
    {#each cards as { id, ...card } (id)}
      <FallingCard {...card} />
    {/each}
    <!-- <g clip-path="url(#clip)">
      {#each cards as { id, ...card } (id)}
	  <FallingCard {...card} stroked={true} />
      {/each}
    </g> -->
    <path
      fill="hsl(-138deg, 50%, 40%)"
      stroke="white"
      stroke-width="3"
      d="M237.992,133.051l-48.872,-133.029l-34.585,0l-49.247,133.029l35.337,-0l6.579,-21.292l48.871,-0l6.579,21.292l35.338,-0Zm-49.435,-45.222l-33.646,-0l16.353,-56.151l17.293,56.151Zm199.995,45.222l0,-133.029l-48.495,0l-24.623,93.083l-25,-93.083l-48.495,0l-0,133.029l32.33,-0c0,-0 -0.188,-80.835 -0.752,-99.489l27.443,99.489l28.759,-0l27.631,-99.489c-0.752,26.003 -0.752,99.489 -0.752,99.489l31.954,-0Zm7.331,-0l65.036,-0c27.067,-0 48.871,-12.813 48.871,-37.308c0,-23.365 -20.676,-29.96 -33.457,-31.091c8.082,-0.942 28.382,-7.348 28.382,-29.771c0,-19.408 -12.029,-34.859 -46.991,-34.859l-61.841,0l0,133.029Zm31.578,-80.458l0,-27.699l27.255,0c6.391,0 17.481,0.566 17.481,13.379c0,13.755 -12.593,14.32 -19.736,14.32l-25,-0Zm0,56.339l0,-32.221l28.571,0c6.767,0 20.113,0.377 20.113,16.394c-0,15.262 -14.85,15.827 -25.564,15.827l-23.12,0Zm119.735,24.119l-0,-133.029l-33.082,0l-0,133.029l33.082,-0Zm407.322,-0l0,-28.076l-51.879,0l0,-104.953l-33.082,0l0,133.029l84.961,-0Zm114.095,-133.029l-33.27,0l0,84.792c0,15.262 -5.827,23.742 -22.743,23.742c-14.85,-0 -23.872,-4.334 -23.872,-22.046l-0,-86.488l-33.458,0l-0,82.719c-0,36.743 24.999,53.325 56.202,53.325c35.901,-0 57.141,-22.235 57.141,-55.586l0,-80.458Zm-238.575,-0.022l-45,-0c-25.2,9.694 -41.606,35.473 -41.606,66.348c0,45.034 28.383,70.66 63.533,70.66c27.631,-0 46.615,-15.828 57.141,-34.294l-26.127,-13.378c-4.511,7.726 -11.466,19.785 -28.759,19.785c-17.856,-0 -32.706,-14.509 -32.706,-43.715c0,-22.234 11.278,-42.208 32.706,-42.208c13.534,0 25.376,10.364 28.195,20.35l26.315,-13.189c-6.405,-13.612 -18.746,-24.686 -33.692,-30.359Zm-188.074,0.022l-49.457,0c-29.521,10.956 -40.988,41.51 -40.988,65.949c-0,36.555 22.18,71.037 65.976,71.037c42.668,-0 66.916,-33.917 66.916,-69.529c-0,-25.524 -12.342,-56.438 -42.447,-67.457Zm-57.739,65.572c-0,-17.9 7.707,-41.83 32.894,-41.83c23.496,-0 34.022,19.219 34.022,43.338c-0,18.654 -8.835,41.642 -33.458,41.642c-23.872,-0 -33.458,-21.857 -33.458,-43.15Zm596.877,52.13l0,-42.407c-7.187,-7.27 -17.877,-9.977 -25.648,-10.665c6.256,-0.729 19.831,-4.732 25.648,-16.903l0,-27.242c-5.248,-12.136 -18.557,-20.485 -44.257,-20.485l-61.841,0l0,133.029l65.036,-0c17.256,-0 32.372,-5.207 41.062,-15.327Zm-74.519,-8.792l-0,-32.221l28.57,0c6.767,0 20.113,0.377 20.113,16.394c-0,15.262 -14.85,15.827 -25.564,15.827l-23.119,0Zm-0,-56.339l-0,-27.699l27.255,0c6.39,0 17.48,0.566 17.48,13.379c0,13.755 -12.593,14.32 -19.736,14.32l-24.999,-0Zm-1106.58,-20.752l-0,70.901c10.751,22.171 31.705,34.266 55.853,34.266c27.631,-0 46.615,-15.828 57.141,-34.294l-26.127,-13.378c-4.511,7.726 -11.466,19.785 -28.759,19.785c-17.857,-0 -32.706,-14.509 -32.706,-43.715c0,-22.234 11.278,-42.208 32.706,-42.208c13.534,0 25.376,10.364 28.195,20.35l26.315,-13.189c-6.396,-13.594 -18.713,-24.657 -33.634,-30.337l-45.115,0c-14.889,5.746 -26.703,17.109 -33.869,31.819Z"
    />
    <text x="200" y="200"
      >innerHeight {innerHeight}, outerHeight {outerHeight}, innerWidth {innerWidth},
      outerWidth {outerWidth}</text
    >
  </g>
</svg>

<style>
  :global(body) {
    padding: 0;
  }
</style>
